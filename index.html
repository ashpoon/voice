<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Voice talent</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.js"></script>
	<style>
		.container {
			width: 800px;
		}
		.voice-search-input {
			margin-bottom: 1rem;
		}
		.voice-search-options {
			display: flex;
			flex-wrap: wrap;
		}
		.voice-search-options label {
			min-width: 10rem;
			cursor: pointer;
			user-select: none; /* prevent double click highlight */
		}
		.voice-search-results td {
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		audio {
			display: block;
			width: 4rem;
			margin-left: 0.3rem;
		}
	</style>
</head>
<body>

<div class="container">
  
	<h1 class="display-1">Voice talent</h1>

	<input type="text" class="voice-search-input form-control" placeholder="Search..." autocomplete="off">
	<form class="voice-search-options"></form>

	<br>

	<p class="voice-search-summary"></p>

	<table class="table voice-search-results">
	<tbody>
	</tbody>
	</table>
</div>

<script id="search-option-template" type="text/x-handlebars-template">
	<label>
		<input type="checkbox" class="voice-search-option" value="{{key}}"> {{label}}
	</label>
</script>

<script id="search-result-template" type="text/x-handlebars-template">
	<tr>
		<td>
			<span class="search-result-body"><strong>{{name}}</strong> {{headers}}</span>
			<span class="search-result-audio">
				{{#if sample}}
				<audio src="samples/{{sample}}" controls="controls">Your browser does not support audio tags</audio>
				{{/if}}
			</span>
		</td>
	</tr>
</script>

<script>
	let data;
	let headers = [];

	const searchButtonDom = document.querySelector(".voice-search-input");
	const searchOptionsDom = document.querySelector(".voice-search-options");
	const searchResultsDom = document.querySelector(".voice-search-results tbody");
	const summaryDom = document.querySelector(".voice-search-summary");

	const searchOptionTemplate = Handlebars.compile(document.getElementById("search-option-template").innerHTML);
	const searchResultTemplate = Handlebars.compile(document.getElementById("search-result-template").innerHTML);

	loadData("data/voice-actors.csv");

	function loadData(url) {
		Papa.parse(url, {
			download: true,
			header: true,
			dynamicTyping: true,
			skipEmptyLines: true,
			complete: function (results) {
				data = results.data;
				headers = results.meta.fields.filter(function (field) {
					return field && field !== "Name" && field !== "Sample";
				});

				displaySearchOptions(headers);
				initInputs();
				search();
			}
		});
	}

	function initInputs() {
		searchButtonDom.addEventListener("input", search);
		searchOptionsDom.addEventListener("change", search);
	}

	function getCheckedOptions() {
		const checked = document.querySelectorAll('input[type="checkbox"]:checked');
		return Array.prototype.map.call(checked, function (e) { 
			return e.value;
		});
	}

	function search(input) {
		const searchInput = searchButtonDom.value;
		let matched = data.filter(function (row) {
			return row.Name.toLowerCase().includes(searchInput.toLowerCase());
		});
		
		const checkedOptions = getCheckedOptions();
		if (checkedOptions.length) {
			matched = matched.filter(function (row) {
				return checkedOptions.every(function (checkedOption) {
					return row[checkedOption] === true;
				});
			});			
		}

		displaySummary("Matched " + matched.length + " " + maybePlural("actor", matched.length) + ":");
		displaySearchResults(matched);
	}

	function maybePlural(singular, count) {
		return count === 1 ? singular : singular + "s";
	}

	function displaySearchOptions(keys) {
		const form = document.querySelector(".voice-search-options");
		form.innerHTML = keys.map(function (key) {
			return searchOptionTemplate({ key: key, label: prettifyOptionKey(key) });
		}).join("\n");
	}

	function displaySummary(text) {
		summaryDom.innerText = text;
	}

	function displaySearchResults(rows) {
		const templateModel = rows.map(function (row) {
			return {
				name: row.Name,
				sample: row.Sample,
				headers: headers.filter(function (header) {
					return row[header];
				}).sort().map(prettifyOptionKey).join(", ")
			};
			
		});
		
		searchResultsDom.innerHTML = templateModel.map(function (object) {
			return searchResultTemplate(object);
		}).join("\n");
	}

	function prettifyOptionKey(key) {
		return key.replace("_", " ");
	}
</script>

</body>
</html>
